import json
import re

import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
import numpy as np
import matplotlib.cm as cm
import matplotlib
import tikzplotlib


def plot_data(data, filename):
    # Define a mapping from '60s' ... '5s' to numerical values
    second_mapping = {f"{i}": i for i in range(240, 0, -10)}

    ind = np.arange(len(second_mapping))  # the x locations for the groups
    width = 0.35       # the width of the bars

    fig, ax = plt.subplots()
    bottom = np.zeros(len(second_mapping))
    colors = cm.rainbow(np.linspace(0, 1, len(data)))  # Generate as many colors as there are rows

    # Inside your for loop, create each bar as a separate object and append them to a list:
    bars = []
    for i, (label, scores) in enumerate(reversed(data)):
        vals = [scores[s] for s in second_mapping]
        bar = ax.bar(ind, vals, width, bottom=np.zeros(len(second_mapping)), color=colors[i], label=label)
        bars.append(bar)

    # Now, instead of ax.legend(), use:
    ax.legend(handles=[bar[0] for bar in bars])


    ax.set_xlabel('Seconds')
    ax.set_xticks(ind)
    ax.set_xticklabels(list(second_mapping.keys()))
    # ax.bar(ind, vals, width, bottom=bottom, color=colors[i], label=label)
    # ax.legend()
    ax.legend(loc='upper right')
    ax.set_ylabel('Precision@k')
    ax.set_title('Precision at rank k under varying latency cutoffs')

    # ax.set_ylim([0,1])  # Explicitly set y-axis limits

    fig.set_size_inches(25, 6)

#     plt.savefig("test.png", dpi=500)
    tikzplotlib.save(filename)

# 1-edit repairs
one_edit = """
P@1=  60s: 0.29, 55s: 0.274, 50s: 0.257, 45s: 0.253, 40s: 0.231, 35s: 0.203, 30s: 0.182, 25s: 0.146, 20s: 0.123, 15s: 0.096, 10s: 0.068, 5s: 0.039
P@5=  60s: 0.444, 55s: 0.411, 50s: 0.374, 45s: 0.354, 40s: 0.32, 35s: 0.288, 30s: 0.254, 25s: 0.203, 20s: 0.16, 15s: 0.112, 10s: 0.076, 5s: 0.04
P@10= 60s: 0.468, 55s: 0.436, 50s: 0.399, 45s: 0.365, 40s: 0.328, 35s: 0.291, 30s: 0.256, 25s: 0.203, 20s: 0.16, 15s: 0.112, 10s: 0.076, 5s: 0.04
P@15= 60s: 0.478, 55s: 0.439, 50s: 0.401, 45s: 0.367, 40s: 0.33, 35s: 0.293, 30s: 0.257, 25s: 0.203, 20s: 0.16, 15s: 0.112, 10s: 0.076, 5s: 0.04
P@20= 60s: 0.478, 55s: 0.439, 50s: 0.401, 45s: 0.368, 40s: 0.33, 35s: 0.294, 30s: 0.257, 25s: 0.203, 20s: 0.16, 15s: 0.112, 10s: 0.076, 5s: 0.04
P@1k= 60s: 0.482, 55s: 0.444, 50s: 0.405, 45s: 0.371, 40s: 0.333, 35s: 0.296, 30s: 0.259, 25s: 0.205, 20s: 0.16, 15s: 0.112, 10s: 0.076, 5s: 0.04
"""

# 2-edit repairs (384)
two_edits = """
P@1=  60s: 0.016, 55s: 0.018, 50s: 0.016, 45s: 0.016, 40s: 0.016, 35s: 0.013, 30s: 0.01, 25s: 0.01, 20s: 0.008, 15s: 0.008, 10s: 0.01, 5s: 0.008
P@5=  60s: 0.044, 55s: 0.039, 50s: 0.039, 45s: 0.039, 40s: 0.034, 35s: 0.029, 30s: 0.029, 25s: 0.023, 20s: 0.021, 15s: 0.021, 10s: 0.013, 5s: 0.008
P@10= 60s: 0.081, 55s: 0.068, 50s: 0.062, 45s: 0.055, 40s: 0.049, 35s: 0.047, 30s: 0.039, 25s: 0.029, 20s: 0.031, 15s: 0.029, 10s: 0.018, 5s: 0.008
P@15= 60s: 0.089, 55s: 0.076, 50s: 0.07, 45s: 0.065, 40s: 0.057, 35s: 0.052, 30s: 0.044, 25s: 0.036, 20s: 0.034, 15s: 0.029, 10s: 0.018, 5s: 0.008
P@20= 60s: 0.094, 55s: 0.083, 50s: 0.076, 45s: 0.073, 40s: 0.065, 35s: 0.06, 30s: 0.047, 25s: 0.036, 20s: 0.034, 15s: 0.029, 10s: 0.018, 5s: 0.008
P@1k= 60s: 0.12, 55s: 0.099, 50s: 0.086, 45s: 0.078, 40s: 0.07, 35s: 0.062, 30s: 0.049, 25s: 0.039, 20s: 0.036, 15s: 0.029, 10s: 0.018, 5s: 0.008
"""

# 3-edit repairs (200)
three_edits = """
P@1=  60s: 0.005, 55s: 0.005, 50s: 0.005, 45s: 0.0, 40s: 0.0, 35s: 0.0, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
P@5=  60s: 0.005, 55s: 0.005, 50s: 0.005, 45s: 0.0, 40s: 0.005, 35s: 0.005, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
P@10= 60s: 0.01, 55s: 0.01, 50s: 0.01, 45s: 0.005, 40s: 0.005, 35s: 0.005, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
P@15= 60s: 0.01, 55s: 0.01, 50s: 0.01, 45s: 0.005, 40s: 0.005, 35s: 0.005, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
P@20= 60s: 0.01, 55s: 0.01, 50s: 0.01, 45s: 0.005, 40s: 0.005, 35s: 0.005, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
P@1k= 60s: 0.01, 55s: 0.01, 50s: 0.01, 45s: 0.005, 40s: 0.005, 35s: 0.005, 30s: 0.0, 25s: 0.0, 20s: 0.0, 15s: 0.0, 10s: 0.0, 5s: 0.0
"""

# All repairs (1233)
all_edits = """
P@1=  240s: 0.342, 230s: 0.342, 220s: 0.342, 210s: 0.329, 200s: 0.329, 190s: 0.329, 180s: 0.329, 170s: 0.316, 160s: 0.304, 150s: 0.291, 140s: 0.278, 130s: 0.278, 120s: 0.266, 110s: 0.266, 100s: 0.253, 90s: 0.228, 80s: 0.228, 70s: 0.19, 60s: 0.203, 50s: 0.177, 40s: 0.165, 30s: 0.177, 20s: 0.152, 10s: 0.139, 5s: 0.063
P@5=  240s: 0.557, 230s: 0.557, 220s: 0.57, 210s: 0.57, 200s: 0.57, 190s: 0.57, 180s: 0.544, 170s: 0.519, 160s: 0.506, 150s: 0.494, 140s: 0.506, 130s: 0.494, 120s: 0.468, 110s: 0.481, 100s: 0.468, 90s: 0.43, 80s: 0.405, 70s: 0.354, 60s: 0.354, 50s: 0.316, 40s: 0.304, 30s: 0.291, 20s: 0.228, 10s: 0.165, 5s: 0.076
P@10= 240s: 0.696, 230s: 0.696, 220s: 0.696, 210s: 0.684, 200s: 0.684, 190s: 0.684, 180s: 0.646, 170s: 0.62, 160s: 0.608, 150s: 0.595, 140s: 0.582, 130s: 0.57, 120s: 0.544, 110s: 0.532, 100s: 0.506, 90s: 0.468, 80s: 0.443, 70s: 0.392, 60s: 0.392, 50s: 0.354, 40s: 0.329, 30s: 0.291, 20s: 0.228, 10s: 0.165, 5s: 0.076
P@15= 240s: 0.696, 230s: 0.696, 220s: 0.696, 210s: 0.684, 200s: 0.684, 190s: 0.684, 180s: 0.646, 170s: 0.62, 160s: 0.608, 150s: 0.608, 140s: 0.595, 130s: 0.582, 120s: 0.557, 110s: 0.544, 100s: 0.519, 90s: 0.481, 80s: 0.443, 70s: 0.392, 60s: 0.392, 50s: 0.354, 40s: 0.329, 30s: 0.291, 20s: 0.228, 10s: 0.165, 5s: 0.076
P@20= 240s: 0.696, 230s: 0.696, 220s: 0.696, 210s: 0.684, 200s: 0.696, 190s: 0.696, 180s: 0.658, 170s: 0.633, 160s: 0.62, 150s: 0.608, 140s: 0.595, 130s: 0.582, 120s: 0.557, 110s: 0.544, 100s: 0.519, 90s: 0.481, 80s: 0.443, 70s: 0.392, 60s: 0.392, 50s: 0.354, 40s: 0.329, 30s: 0.291, 20s: 0.228, 10s: 0.165, 5s: 0.076
P@1k= 240s: 0.747, 230s: 0.747, 220s: 0.747, 210s: 0.734, 200s: 0.734, 190s: 0.734, 180s: 0.696, 170s: 0.671, 160s: 0.658, 150s: 0.646, 140s: 0.633, 130s: 0.62, 120s: 0.595, 110s: 0.582, 100s: 0.557, 90s: 0.519, 80s: 0.468, 70s: 0.405, 60s: 0.405, 50s: 0.367, 40s: 0.342, 30s: 0.304, 20s: 0.228, 10s: 0.165, 5s: 0.076
"""

if __name__ == '__main__':
    pattern = r"(P@\w+)=((?:\s+\d+s:\s+\d+\.\d+,?)+)"
    matches = re.findall(pattern, all_edits)

    data = []
    for match in matches:
        key = match[0].strip()
        values = re.findall(r"(\d+)s:\s+(\d+\.\d+)", match[1])
        data.append((key, {k: float(v) for k, v in values}))

    print(json.dumps(data))

    # data = [
    #     ("P@1", {"60": 0.446, "55": 0.428, "50": 0.406, "45": 0.364, "40": 0.342, "35": 0.327, "30": 0.302, "25": 0.265,
    #              "20": 0.218, "15": 0.173, "10": 0.119, "5": 0.079}),
    #     ("P@5", {"60": 0.649, "55": 0.626, "50": 0.599, "45": 0.532, "40": 0.505, "35": 0.475, "30": 0.436, "25": 0.366,
    #              "20": 0.312, "15": 0.248, "10": 0.161, "5": 0.092}),
    #     ("P@10", {"60": 0.715, "55": 0.683, "50": 0.646, "45": 0.574, "40": 0.542, "35": 0.5, "30": 0.458, "25": 0.384,
    #               "20": 0.319, "15": 0.252, "10": 0.161, "5": 0.094}),
    #     ("P@20", {"60": 0.75, "55": 0.713, "50": 0.668, "45": 0.594, "40": 0.559, "35": 0.51, "30": 0.463, "25": 0.389,
    #               "20": 0.319, "15": 0.257, "10": 0.166, "5": 0.097}),
    #     ("P@1k",
    #      {"60": 0.787, "55": 0.745, "50": 0.698, "45": 0.619, "40": 0.582, "35": 0.525, "30": 0.475, "25": 0.401,
    #       "20": 0.329, "15": 0.262, "10": 0.168, "5": 0.097})
    # ]
    # print(data)
    plot_data(data, "repair1-3_plot.tex")
